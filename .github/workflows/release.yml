name: Release

on:
  push:
    tags:
      - 'v*'

env:
  BUILD_TYPE: Release

jobs:
  # Build release artifacts on multiple platforms
  build-release:
    name: Build Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
          - os: macos-14
            platform: macos-x64
          - os: windows-2022
            platform: windows-x64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'


    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build pybind11-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja pybind11

    - name: Install system dependencies (Windows)
      if: runner.os == 'Windows'
      uses: lukka/get-cmake@latest

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11 numpy build twine

    - name: Build C++ engine
      shell: bash
      run: |
        chmod +x build_cpp_engine.sh
        ./build_cpp_engine.sh

    - name: Build Python package
      run: |
        python -m build --wheel --sdist


    - name: Create release archives
      shell: bash
      run: |
        # Create directories for artifacts
        mkdir -p release-artifacts/python
        mkdir -p release-artifacts/cpp
        mkdir -p release-artifacts/docs

        # Copy Python artifacts
        cp dist/*.whl release-artifacts/python/
        cp dist/*.tar.gz release-artifacts/python/

        # Copy C++ libraries (if built)
        if [ -d "cpp/microkernel/build" ]; then
          cp cpp/microkernel/build/libmicrokernel.a release-artifacts/cpp/ || true
        fi
        if [ -d "cpp/extendedkernel/build" ]; then
          cp cpp/extendedkernel/build/libextendedkernel.a release-artifacts/cpp/ || true
        fi
        if [ -d "python/similar2logo" ]; then
          find python/similar2logo -name "*.so" -o -name "*.dylib" -o -name "*.dll" | xargs -I {} cp {} release-artifacts/cpp/ || true
        fi

        # Copy documentation
        cp README.md release-artifacts/docs/
        cp *.md release-artifacts/docs/ || true
        cp -r docs/* release-artifacts/docs/ || true

        # Note: Artifacts are uploaded as directories, not archives
        # Final archives will be created in the release job

    - name: Upload Python artifacts
      uses: actions/upload-artifact@v5
      with:
        name: python-artifacts-${{ matrix.platform }}
        path: release-artifacts/python/

    - name: Upload C++ artifacts
      uses: actions/upload-artifact@v5
      with:
        name: cpp-artifacts-${{ matrix.platform }}
        path: release-artifacts/cpp/

    - name: Upload documentation
      uses: actions/upload-artifact@v5
      with:
        name: docs-${{ matrix.platform }}
        path: release-artifacts/docs/

  # Publish to PyPI (if configured)
  pypi-publish:
    name: Publish to PyPI
    runs-on: ubuntu-22.04
    needs: build-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/download-artifact@v4
      with:
        name: python-artifacts
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
      # Uncomment the line above and add PYPI_API_TOKEN secret to enable PyPI publishing

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs: build-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create release archives
      run: |
        # Create platform-specific archives
        for platform in linux-x64 macos-x64 windows-x64; do
          echo "Creating archive for $platform..."
          mkdir -p "release-$platform"

          # Copy Python artifacts for this platform
          if [ -d "artifacts/python-artifacts-$platform" ]; then
            cp -r "artifacts/python-artifacts-$platform"/* "release-$platform/" 2>/dev/null || true
          fi

          # Copy C++ artifacts for this platform
          if [ -d "artifacts/cpp-artifacts-$platform" ]; then
            cp -r "artifacts/cpp-artifacts-$platform"/* "release-$platform/" 2>/dev/null || true
          fi

          # Copy documentation (only from linux build)
          if [ -d "artifacts/docs-linux-x64" ] && [ "$platform" = "linux-x64" ]; then
            cp -r "artifacts/docs-linux-x64"/* "release-$platform/" 2>/dev/null || true
          fi

          # Create platform archive if it has content
          if [ -d "release-$platform" ] && [ "$(ls -A "release-$platform" 2>/dev/null)" ]; then
            if [[ "$platform" == windows-* ]]; then
              # Windows: create zip (if zip available, otherwise tar)
              if command -v zip >/dev/null 2>&1; then
                zip -r "SIMILAR-${{ github.ref_name }}-$platform.zip" "release-$platform/"
              else
                tar -czf "SIMILAR-${{ github.ref_name }}-$platform.tar.gz" -C "release-$platform" .
              fi
            else
              # Unix: create tar.gz
              tar -czf "SIMILAR-${{ github.ref_name }}-$platform.tar.gz" -C "release-$platform" .
            fi
          fi
        done

        # Create source archive
        tar -czf SIMILAR-${{ github.ref_name }}-source.tar.gz \
          --exclude='.git' \
          --exclude='target' \
          --exclude='build' \
          --exclude='__pycache__' \
          --exclude='*.so' \
          --exclude='*.dylib' \
          --exclude='*.dll' \
          .

    - name: Generate release notes
      run: |
        # Extract version from tag
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        # Generate basic release notes
        cat > release-notes.md << EOF
        # SIMILAR ${VERSION} Release

        This release includes updates to the SIMILAR multi-agent simulation framework.

        ## What's New

        - Enhanced C++ performance with multithreaded simulation engine
        - Improved Python bindings and DSL
        - Updated Similar2Logo components
        - Bug fixes and stability improvements

        ## Components

        - **C++ Core**: Multithreaded simulation engine with enhanced performance
        - **Python Bindings**: Complete Similar2Logo DSL with web visualization
        - **C++ Libraries**: Pre-compiled libraries for Linux, macOS, and Windows
        - **Documentation**: Comprehensive guides and examples

        ## Installation

        ### Python
        \`\`\`bash
        pip install similar2logo
        \`\`\`

        ### From Source
        See README.md for detailed build instructions.

        ## Compatibility

        - Python 3.8+
        - CMake 3.15+
        - C++17 compatible compiler

        ---
        Built on: $(date)
        Commit: ${{ github.sha }}
        EOF

    - name: Create GitHub release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          SIMILAR-${{ github.ref_name }}-source.tar.gz
          SIMILAR-${{ github.ref_name }}-linux-x64.tar.gz
          SIMILAR-${{ github.ref_name }}-macos-x64.tar.gz
          SIMILAR-${{ github.ref_name }}-windows-x64.zip
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
